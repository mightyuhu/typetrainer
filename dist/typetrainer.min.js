/*! typetrainer - v0.0.1 - 2013-11-02
* Copyright (c) 2013 ; Licensed  */
$(function(){var a=function(){this.alphabet="yyyzzz0123456789abcdefghijklmnopqrstuvwxyz",this.keys=":;\\'!@#$%^&*()[]{}`~/|/|_+=-/?>",this.lection="",this.lectionText="",this.score={hits:0,misses:0,lastCheckLength:0},this.config={bufferSize:25,bufferReluctanceFactor:3,eventHolder:$("body"),lesson:"random-full"}};a.prototype.generateRandomLetter=function(){var a=this.keys;return"random-full"===this.config.lesson?(console.log("alphabet"),a+=this.alphabet):"random-letter"===this.config.lesson?a=this.alphabet:"random-yz"===this.config.lesson?a="zy":"random-homerow"===this.config.lesson?a="asdfghjkl;':\"|\\":"random-homerow-bottomrow"===this.config.lesson?a="\\||zxcvbnm,./<>?/asdfghjkl;':\"|\\":"random-homerow-toprow"===this.config.lesson?a="qwertyuiop[]{}asdfghjkl;':\"|\\":"random-bottomrow"===this.config.lesson?a="\\||zxcvbnm,./<>?/":"random-toprow"===this.config.lesson?a="qwertyuiop[]{}":"random-numberspechials"===this.config.lesson&&(a="!@#$%^&*()_+=-"),a[Math.ceil(Math.random()*a.length)-1]},a.prototype.clearLection=function(){this.lection="",this.lectionText="",this.config.eventHolder.trigger("tt.lection_update")},a.prototype.clearScore=function(){this.score.hits=0,this.score.misses=0,this.config.eventHolder.trigger("tt.score_update")},a.prototype.populateLectionBuffer=function(){if(/random-/g.test(this.config.lesson))for(;this.lection.length<this.config.bufferSize;)this.lection=this.lection+this.generateRandomLetter(),this.config.eventHolder.trigger("tt.lection_update");else if(this.config.lesson="wikipedia"){if(this.lectionText.length<this.config.bufferReluctanceFactor*this.config.lesson.length){var a=this;$.ajax({url:"https://en.wikipedia.org/w/api.php?action=query&list=random&rnnamespace=0&rnlimit=1&format=json",cache:!1,dataType:"jsonp",success:function(b){var c=b.query.random[0].id;$.ajax({url:"https://en.wikipedia.org/w/api.php?action=query&prop=extracts&exchars=700&format=json&explaintext&pageids="+c,cache:!1,dataType:"jsonp",success:function(b){var d=b.query.pages[c].extract;for(d=d.replace(/[\u0080-\uffff]/g,"").replace(/(\r\n|\n|\r)/gm,""),a.lectionText+=d,console.log(b.query.pages[c].extract);a.lection.length<a.config.bufferSize;)a.lection=a.lectionText.slice(0,Math.min(a.config.bufferSize,a.lectionText.length)),a.config.eventHolder.trigger("tt.lection_update")}})}})}for(;this.lection.length<this.config.bufferSize&&this.lectionText.length>this.config.bufferSize;)this.lection=this.lectionText.slice(0,Math.min(this.config.bufferSize,this.lectionText.length)),this.config.eventHolder.trigger("tt.lection_update")}},a.prototype.generateLection=function(){this.clearLection(),this.populateLectionBuffer()},a.prototype.reloadLection=function(a){this.config.lesson=a,this.generateLection()},a.prototype.tryRemove=function(a){return a[0]===this.lection[0]?(this.lection=this.lection.slice(1,this.lection.length),this.lectionText=this.lectionText.slice(1,this.lectionText.length),this.score.hits++,this.config.eventHolder.trigger("tt.score_update"),this.populateLectionBuffer(),this.score.lastCheckLength=a.length,a.slice(1,a.length)):(this.score.lastCheckLength<a.length&&(this.score.misses+=a.length-this.score.lastCheckLength,this.config.eventHolder.trigger("tt.score_update")),this.score.lastCheckLength=a.length,a)},a.prototype.tryRemoveBuffer=function(a){var c=!0;if(!a)return this.score.lastCheckLength=a.length,"";for(;a.length>0&&c;){var d=a.length;a=b.tryRemove(a),console.log(a),c=d>a.length}return this.score.lastCheckLength=a.length,a},a.prototype.init=function(){this.generateLection()};var b=new a;$("#input-lifo").on("keyup",function(){$(this).val(b.tryRemoveBuffer($(this).val())).toggleClass("hasMiss",$(this).val().length>0).attr("placeholder","")}).focus(),$("#lesson-select").on("change",function(){b.reloadLection($(this).val())}),$("#reload").on("click",function(){$("#input-lifo").val("").focus(),b.clearScore(),b.generateLection()}),$("body").on("tt.lection_update",function(){for(var a=0,c="",d=1,e="";a<b.lection.length;)d=(b.lection.length-a)/b.lection.length,e=0===a?"color:orange;font-size:2.7em;":"color:rgba(255,255,255,"+d+");font-size:"+2.5*d*d+"em;",c+='<span style="'+e+'">',c+=0===a&&" "===b.lection[a]?"[ ]":b.lection[a],c+="</span>",a++;$("#lesson").html(c)}),$("body").on("tt.score_update",function(){$("#score").html("Misses|Hits: "+b.score.misses+" - "+b.score.hits)}),b.init()});